# Детальный план работ: Backend MVP "АстроТочка"

**Цель:** Создать серверное приложение (API), которое будет управлять данными и логикой для Mini App и админ-панели.

**Технологический стек:**
*   **Язык:** TypeScript
*   **Фреймворк:** **NestJS**
*   **База данных:** PostgreSQL
*   **ORM (для работы с БД):** **Prisma**

---

### Шаг 1: Инициализация проекта и настройка окружения (1-2 дня)

1.  **Установить NestJS CLI:** `npm install -g @nestjs/cli`
2.  **Создать новый проект:** `nest new astro-point-backend`
3.  **Настроить Docker для PostgreSQL:** Создать `docker-compose.yml` для легкого запуска базы данных в контейнере.
4.  **Установить и настроить Prisma:**
    -   `npm install prisma --save-dev`
    -   `npx prisma init --datasource-provider postgresql`
    -   Настроить строку подключения к БД в файле `.env`.
    -   Выполнить первую пустую миграцию для проверки соединения: `npx prisma migrate dev --name init`.

* **Результат:** Пустой, но работающий NestJS-проект, подключенный к базе данных.

### Шаг 2: Описание моделей данных (Схема БД) (1 день)

1.  **Описать модели в `schema.prisma`:** Определить все таблицы (`User`, `Expert`, `Tag`, `ContentSource`, `ContentItem`, `Funnel`, `FunnelStep`) и связи между ними.
    ```prisma
    // Пример для schema.prisma

    model User {
      id         Int      @id @default(autoincrement())
      telegramId BigInt   @unique
      firstName  String?
      createdAt  DateTime @default(now())
      // ... и другие поля
    }

    model Expert {
      id    Int     @id @default(autoincrement())
      name  String
      bio   String?
      photo String?
      // ... и другие поля
    }
    ```
2.  **Создать миграцию:** Выполнить `npx prisma migrate dev --name create_models`. Prisma автоматически создаст SQL-скрипты и применит их к базе данных, создав все таблицы.

* **Результат:** Готовая структура базы данных, соответствующая документации.

### Шаг 3: Реализация базового API для справочников (2 дня)

1.  **Сгенерировать модули:** `nest g module experts` и `nest g module tags`.
2.  **Сгенерировать сервисы и контроллеры:** `nest g service experts`, `nest g controller experts` (аналогично для `tags`).
3.  **Реализовать CRUD-операции:** В контроллерах определить API-методы, а в сервисах — логику работы с базой данных через Prisma.
    -   `GET /experts`: Получить список всех экспертов.
    -   `POST /experts`: Создать нового эксперта.
    -   `GET /experts/:id`: Получить одного эксперта.
    -   `PATCH /experts/:id`: Обновить эксперта.
    -   `DELETE /experts/:id`: Удалить эксперта.
    -   (Аналогично для `/tags`)

* **Результат:** Рабочие API-endpoints для управления справочниками, готовые для интеграции с админ-панелью.

### Шаг 4: Аутентификация и пользователи (1-2 дня)

1.  **Установить модули:** `npm install @nestjs/passport passport @nestjs/jwt passport-jwt`.
2.  **Реализовать логику аутентификации:** Создать `AuthModule`. В нем — сервис, который будет проверять `initData` от Telegram и находить/создавать пользователя в БД.
3.  **Настроить JWT-стратегию:** После успешной проверки `initData` генерировать JWT-токен и отдавать его клиенту.
4.  **Защитить эндпоинты:** Использовать `@UseGuards(JwtAuthGuard)` для защиты роутов, которые требуют авторизации.

* **Результат:** Безопасный Backend. Пользователь может "войти" в систему, и мы можем идентифицировать его по токену.

---

**Итог по Backend MVP (5-7 дней):**
Готовое к работе серверное приложение с настроенной базой данных, базовым API для справочников и системой аутентификации. На этой основе можно начинать разработку **Админ-панели** и **Frontend-приложения**.